<!--
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" charset="utf-8"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js" charset="utf-8"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
</head>
<style>
  body {
    color: #2A1506;
  }
  .testInput {
    margin: 1em;
  }

  .result {
    background-color: #f2e8d5;
    padding: 1em 0 1em 1em;
    margin: 1em;
  }
  .result .header {
    cursor: pointer;
  }
  .result .title {
    font-size: 1.75em;
  }
  .result .title a {
    font-size: .75em;
    color: #0E0077;
    margin-left: .5em;
  }
  .result .description {
    font-size: 1.25em;
    margin-bottom: .5em;
  }
  .result .fatalError {
    padding-top: .75em;
    font-weight: bold;
  }
  .result .score {
    padding: .25em;
  }
  .score.perfect {
    background-color: #39b54a;
  }
  .score.high {
    background-color: #a8bd04;
  }
  .score.low {
    background-color: #e7c333;
  }
  .score.error {
    background-color: #dd4a38;
  }

  #overallScore {
    text-align: center;
    color: #aaa;
    font-size: 2em;
  }
  #overallScore div {
    display: inline-block;
    vertical-align: middle;
  }
  #overallScore .perfect, #overallScore .high, #overallScore .low, #overallScore .error {
    font-size: 4.8em;
    padding: 0 10px;
  }
  #overallScore .perfect {
    color: #39b54a;
  }
  #overallScore .high {
    color: #a8bd04;
  }
  #overallScore .low {
    color: #e7c333;
  }
  #overallScore .error {
    color: #dd4a38;
  }
</style>
<body>

<div class="col-md-6">
  <h2>GA4GH compliance tests</h2>
  <form class="form testInput" role="form">
    <div class="form-group">
      <label for="endpoint">API endpoint</label>
      <input type="text" class="form-control" id="endpoint" placeholder="http://..."
             value="https://www.googleapis.com/genomics/v1beta?key=AIzaSyDSCPSt4PhkKoVc8NlcscE_uPvlUppVCEY">
    </div>
    <div class="form-group">
      <label for="datasetId">Dataset ID <small>(which contains a read group set named NA12878)</small></label>
      <input type="text" class="form-control" id="datasetId"
             placeholder="The dataset should contain NA12878" value="376902546192">
    </div>
    <button id="formButton" class="btn btn-default" data-loading-text="Testing..."
            onclick="runTests(); return false;">Test</button>
  </form>

  <div id="overallScore"></div>
</div>

<div id="results" class="col-md-6"></div>


<script type="text/javascript">
  var results = $('#results');
  var formButton = $('#formButton');
  var overallScore = $('#overallScore');

  function error(result, message) {
    result.fatalErrors.push(message);
  }

  function httpError(result, event) {
    error(result, 'Http error: ' + event.statusText + ' (' + event.status + ')');
  }

  function assert(result, test, message) {
    var warning = !test;
    result.tests.push({message: message, warning: warning});
    return warning;
  }

  function assertField(result, fieldValue, fieldName, fieldType) {
    var valueExists = !_.isUndefined(fieldValue);

    if (valueExists) {
      fieldType = fieldType || 'string';

      var message = 'Field ' + fieldName + ' is a ' + fieldType;
      var test = typeof fieldValue == fieldType;

      if (fieldType == 'long') {
        // Longs in json are formatted as strings, yet should be parseable as numbers
        test = !_.isNaN(parseInt(fieldValue));
      } else if (fieldType == 'array') {
        // typeof doesn't work on arrays
        test = _.isArray(fieldValue);
      }
      assert(result, test, message);

    } else {
      // TODO: Distinguish optional fields from required ones
      // For now we will mark the field as successful
      assert(result, true, 'Field ' + fieldName + ' is missing and can\'t be tested');
    }
  }

  function assertFields(result, object, prefix, fields) {
    _.each(fields, function(name) {
      var type = 'string';
      if (_.isArray(name)) {
        type = name[1];
        name = name[0];
      }
      assertField(result, object[name], prefix + name, type);
    });
  }

  function assertArrayObject(result, parent, objectName, prefix, fields) {
    var objects = parent[objectName] || [];
    assert(result, objects.length > 0, 'Field ' + prefix + objectName + ' is non-empty');
    assertFields(result, _.first(objects) || {}, prefix + objectName + '.', fields);
  }

  function getUrl(path) {
    var l = document.createElement('a');
    l.href = $('#endpoint').val();
    l.pathname += path;
    return l.href;
  }

  function testReadGroupSetSearch(result, datasetId) {
    var body = JSON.stringify({datasetIds: [datasetId]});

    $.ajax({
      type: 'POST',
      url: getUrl('/readgroupsets/search'),
      data: body,
      contentType: 'application/json; charset=utf-8'
    }).always(function(json) {
      if (json.status) {
        httpError(result, json);
      }

      assert(result, json.readGroupSets, 'Test coming soon!');
      testComplete(result);
    });
  }

  function testReadsetSearchv01(result, datasetId) {
    var body = JSON.stringify({datasetIds: [datasetId]});

    $.ajax({
      type: 'POST',
      url: getUrl('/readsets/search'),
      data: body,
      contentType: 'application/json; charset=utf-8'
    }).always(function(json) {
      if (json.status) {
        httpError(result, json);
      }

      var sets = json.readsets || [];
      assert(result, sets.length > 0, 'Field readsets is non-empty');

      var readset = _.first(sets) || {};
      var prefix = 'readsets[0].';
      assertFields(result, readset, prefix, ['id', 'name', 'datasetId',
        ['created', 'long'], ['readCount', 'long']]);

      // fileData
      var filedata = readset.fileData || [];
      assert(result, filedata.length > 0, 'Field readsets[0].fileData is non-empty');

      var data = _.first(filedata) || {};
      prefix += 'fileData[0].';

      assertFields(result, data, prefix, ['fileUri', ['comments', 'array']]);

      assertArrayObject(result, data, 'headers', prefix,
          ['version', 'sortingOrder']);

      assertArrayObject(result, data, 'refSequences', prefix,
          ['name', ['length', 'number'], 'assemblyId', 'md5Checksum',
            'species', 'uri']);

      assertArrayObject(result, data, 'readGroups', prefix,
          ['id', 'sequencingCenterName', 'description', 'date', 'flowOrder',
            'keySequence', 'library', 'processingProgram',
            ['predictedInsertSize', 'number'], 'sequencingTechnology',
            'platformUnit', 'sample']);

      assertArrayObject(result, data, 'programs', prefix,
          ['id', 'name']);

      testComplete(result);
    });
  }

  //
  // Tests /reads/search
  //  This test uses the provided dataset id to look for a readset named 'NA12878'
  //  Once found, it's then able to search for reads
  //
  function testReadSearchv01(result, datasetId) {
    var body = JSON.stringify({datasetIds: [datasetId], name: 'NA12878'});

    $.ajax({
      type: 'POST',
      url: getUrl('/readsets/search'),
      data: body,
      contentType: 'application/json; charset=utf-8'
    }).always(function(json) {
      if (json.status) {
        httpError(result, json);
      }

      var na12878 = '';
      if (json.readsets) {
        na12878 = json.readsets[0].id;
      } else {
        error(result, 'Could not find a readset for NA12878.');
      }

      var referenceName = '22';
      var referencePosition = 51005354;
       body = JSON.stringify({
        readsetIds: [na12878],
        sequenceName: referenceName,
        sequenceStart: referencePosition,
        sequenceEnd: referencePosition
      });
      $.ajax({
        type: 'POST',
        url: getUrl('/reads/search'),
        data: body,
        contentType: 'application/json; charset=utf-8'
      }).always(function(json) {
        if (json.status) {
          httpError(result, json);
        }

        var reads = json.reads || [];
        assert(result, reads.length > 0, 'Field reads is non-empty');

        var read = _.first(reads) || {};
        assertFields(result, read, 'reads[0].',
            ['id', 'name', 'readsetId', ['flags', 'number'], 'referenceSequenceName',
              ['position', 'number'], ['mappingQuality', 'number'], 'cigar',
              'mateReferenceSequenceName', ['matePosition', 'number'],
              ['templateLength', 'number'], 'originalBases', 'alignedBases',
              'baseQuality']);

        assert(result, _.every(read.tags, function(value, key) {
          return typeof key == 'string' && typeof value[0] == 'string';
        }), 'Field reads[0].tags is a map from string to array of strings');

        testComplete(result);
      });
    });
  }

  function testComplete(result) {
    var div = $('<div/>', {class: 'result'}).appendTo(results);

    function makeDiv(text, className, parent) {
      return $('<div/>', {class: className || ''}).text(text).appendTo(parent || div);
    }

    // Header
    var header = $('<div/>', {class : 'header', 'data-toggle' : 'collapse',
      'data-target': '#' + result.id}).appendTo(div);
    var title = makeDiv(result.title, 'title', header);
    $('<a/>', {href: result.docLink, class: 'glyphicon glyphicon-file',
      target: '_blank', title: 'API Documentation'})
        .appendTo(title).click(function(e) {
          e.stopPropagation();
        });

    makeDiv(result.description, 'description', header);


    // Details
    var details = makeDiv('', 'collapse').attr('id', result.id);

    var score = 0;
    var total = result.tests.length;
    _.map(result.tests, function(x) {
      var row = makeDiv('', 'row', details);

      makeDiv(x.message, 'test col-xs-10', row);
      var icon = 'glyphicon glyphicon-remove';
      if (!x.warning && result.fatalErrors.length == 0) {
        icon = 'glyphicon glyphicon-ok';
        score++;
      }
      $('<div/>', {class: 'status col-xs-1'}).appendTo(row)
          .append($('<span/>', {class: icon}));
    });


    if (result.fatalErrors.length > 0) {
      _.map(result.fatalErrors, function(x) {
        makeDiv(x, 'fatalError', details);
      });
      makeDiv('Testing could not complete due to errors', '', details);
    }

    $('<div/>', {class: 'score pull-right ' + scoreColor(total, score)})
        .text(scoreLabel(total, score)).prependTo(title);

    result.testFinished(total, score);
  }

  function scoreLabel(total, score) {
    if (score == total) {
      return total;
    } else {
      return score + '/' + total;
    }
  }

  function scoreColor(total, score) {
    var fraction = score/total;
    if (fraction == 0) {
      return 'error'
    } else if (fraction == 1) {
      return 'perfect';
    } else if (fraction > .5) {
      return 'high';
    } else {
      return 'low';
    }
  }

  function runTests() {
    results.empty();
    formButton.button('loading');

    var totalScore = 0;
    var totalTests = 0;

    var tests = [];
    var testsFinished = 0;
    function testFinished(total, score) {
      totalTests += total;
      totalScore += score;
      testsFinished++;

      if (testsFinished == tests.length) {
        formButton.button('reset');
        overallScore.empty();
        $('<div/>').text('this API scores').appendTo(overallScore);
        $('<div/>').text(totalScore)
            .attr('class', scoreColor(totalScore, totalTests))
            .appendTo(overallScore);
        $('<div/>').text('out of ' + totalTests + ' points').appendTo(overallScore);
      }
    }

    function addTest(title, description, docLink, test) {
      var resultContainer = {id: 'test' + tests.length, title: title,
        description: description, docLink: docLink,
        fatalErrors: [], tests: [], testFinished: testFinished};
      tests.push(resultContainer);
      return resultContainer;
    }

    var datasetId = $('#datasetId').val();

    // v0.5
    var docUrlPrefix = 'http://ga4gh.org/documentation/api/v0.5/ga4gh_api.html#/schema/';
    testReadGroupSetSearch(addTest(
        'Search Reference Sets',
        'Fetches reference sets',
        docUrlPrefix + 'org.ga4gh.GASearchReferenceSetsRequest'), datasetId);
    testReadGroupSetSearch(addTest(
        'Search References',
        'Fetches references',
        docUrlPrefix + 'org.ga4gh.searchReferences'), datasetId);
    testReadGroupSetSearch(addTest(
        'Search Read Group Sets',
        'Fetches read group sets from the specified dataset',
        docUrlPrefix + 'org.ga4gh.searchReadGroupSets'), datasetId);
    testReadGroupSetSearch(addTest(
        'Search Reads',
        'Looks up a readset for NA12878 from the specified dataset, then fetches reads.',
        docUrlPrefix + 'org.ga4gh.searchReads'), datasetId);
    testReadGroupSetSearch(addTest(
        'Search Variants',
        'Fetches variants from the specified dataset.',
        docUrlPrefix + 'org.ga4gh.searchVariants'), datasetId);
    testReadGroupSetSearch(addTest(
        'Search Call Sets',
        'Fetches call sets from the specified dataset.',
        docUrlPrefix + 'org.ga4gh.searchCallSets'), datasetId);


    // v0.1
    testReadsetSearchv01(addTest(
        'Search Readsets (v0.1)',
        'Fetches readsets from the specified dataset and tests their fields.',
        'http://ga4gh.org/#/apis/reads/v0.1/readsets'), datasetId);
    testReadSearchv01(addTest(
        'Search Reads (v0.1)',
        'Looks up a readset for NA12878 from the specified dataset, then fetches reads.',
        'http://ga4gh.org/#/apis/reads/v0.1/reads/search'), datasetId);
  }
  runTests();

</script>
</body>
</html>
